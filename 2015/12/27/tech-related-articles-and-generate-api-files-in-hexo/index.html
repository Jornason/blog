<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Related Articles and generate API files in Hexo | TaoAlpha's Blog</title><meta name="description" content="Here is my new blog based on hexo."><meta name="viewport" content="width=device-width, initial-scale=1"><!-- open graph part--><meta property="og:image" content="http://taoalpha.me/images/newblog.jpg"><meta property="og:description" content="TaoAlpha's hexo Blog"><meta property="og:type" content="website"><link rel="short icon" href="/blog/favicon.png"><link rel="stylesheet" href="/blog/css/default.css"></head><body class="blogpost"><aside class="home-menu"><nav class="home-icon-con upside"></nav><a href="/blog/" class="home-menu-icon brand active">涛</a><a href="/blog/tipme" class="home-menu-icon"><i class="fa fa-1x fa-gratipay"></i></a><a href="javascript:$('.searchbox').focus().css('border', '4px dashed #666');setTimeout(function(){$('.searchbox').focus().css('border', 'none').css('border-bottom', '1px solid #ccc')},1000);" class="home-menu-icon"><i class="fa fa-1x fa-search"></i></a><a href="/blog/puzzle" class="home-menu-icon"><i class="fa fa-1x fa-puzzle-piece"></i></a><a href="javascript:;" title="Contact Me" class="home-menu-icon follow">+</a><div class="home-contact"><a href="http://facebook.com/zzgary/" target="something"><img src="https://cdn1.iconfinder.com/data/icons/social-shade-rounded-rects/512/facebook-32.png" alt="facebook"></a><a href="http://github.com/taoalpha/" target="something"><img src="https://cdn1.iconfinder.com/data/icons/social-shade-rounded-rects/512/github-32.png" alt="github"></a><a href="http://taoalpha.me" target="something"><img src="https://cdn3.iconfinder.com/data/icons/colore-sociale/32/mewally_32x32.png" alt="portfolio"></a><a href="http://douban.com/people/129154019" target="something"><img src="http://img3.douban.com/favicon.ico" alt="douban"></a></div><nav class="home-icon-con downside"><a href="#contribution" class="home-menu-icon makecontribution"><i class="fa fa-pencil fa-1x"></i></a><a id="togglemusic" href="javascript:;" class="home-menu-icon"><i class="fa fa-music fa-1x"></i></a></nav><div id="musicbar"><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="298" height="40" src=""></iframe></div></aside><div id="contribution" class="hide"><span class="close"></span><input id="sender_mail" type="email" placeholder="Give me your email"><textarea id="contributionContent" name="contribution" cols="30" rows="10" placeholder="Thanks for your contribution!  Now tell me what you want to say: feedback ? advice ? contributions ? Whatever you want ^_^.  I will look at it as soon as I receive it and reply you asap.  "></textarea><input id="sendToMe" type="submit"></div><article id="content"><section class="entry"><h1 class="entry-title"><a href="http://taoalpha.me/blog/2015/12/27/tech-related-articles-and-generate-api-files-in-hexo/" title="Related Articles and generate API files in Hexo">Related Articles and generate API files in Hexo</a></h1><div class="meta-top"><a href="http://taoalpha.me"><div style="display:inline-block;" class="avatar"><img src="https://avatars3.githubusercontent.com/u/4335753?v=3&amp;s=40" alt="100"></div><span>TaoAlpha</span></a><span>2015-12-27</span><span class="wordage">5537字</span><span class="readspeed">16 分钟读完</span></div><h2 id="Why_3F"><a href="#Why_3F" class="headerlink" title="Why?"></a>Why?</h2><p>Since I have migrated my entire blog to hexo, so I need to rewrite a lot modules :) Today we talk about related articles and how to generate api files in your hexo blog.</p>
<h2 id="How"><a href="#How" class="headerlink" title="How"></a>How</h2><h3 id="Related_Articles"><a href="#Related_Articles" class="headerlink" title="Related Articles"></a>Related Articles</h3><p>Unlike jekyll, hexo doesn’t have a built-in module to populate the related articles (meanwhile, jekyll’s built-in related articles are sucks, so many people build themselves, I did once before, you can check this <a href="/blog/2015/06/06/tech-jekyll-related-posts-optimization/">Optimize jekyll(in chinese)</a> if you want.), so I have to write one for myself.</p>
<p>The idea is pretty simple and similiar with last one I did for jekyll, use the tag to compare different posts, it they have some common tags, they should be similiar, or related.</p>
<p>So I query the post according to current post’s category and get all posts with same category as current one, then for each post, I compared its tags with current post’s, if there is some intersect between them, I will count it as a related article to current post.</p>
<p>The code is simple too(written in jade):</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- var posts = []&#10;- if(page.categories)&#123;&#10;-   var cat = page.categories.toArray()[0].name&#10;-   var existTags = page.tags.toArray().map(function(v)&#123;return v.name&#125;)&#10;-   var prePosts = site.categories.findOne(&#123;name: cat&#125;).posts&#10;-   if(prePosts.toArray().length&#62;0)&#123;&#10;-     var someCatPosts = prePosts.sort(&#39;date&#39;, -1).toArray()&#10;-     someCatPosts.forEach(function(v)&#123;&#10;-       var tags = v.tags.toArray().map(function(t)&#123;return t.name&#125;).filter(function(n)&#123;return existTags.indexOf(n)!=-1&#125;)&#10;-       if(tags.length&#62;0 &#38;&#38; posts.length &#60; 5 &#38;&#38; v.permalink != page.permalink)&#123;&#10;-         posts.push(v)&#10;-       &#125;&#10;-     &#125;)&#10;-   &#125;&#10;- &#125;&#10;if posts.length &#62; 0&#10;  div.relatedposts.sidenav&#10;    h2= &#34;Related Posts:&#34;&#10;    ul.article-list&#10;      each post in posts&#10;        li&#10;          a(href=url_for(post.permalink))= post.title</span><br></pre></td></tr></table></figure>
<h3 id="API_Generator"><a href="#API_Generator" class="headerlink" title="API Generator"></a>API Generator</h3><p>Since I use static blog, I don’t have any tools or modules like php to deal with post and get request, but what I can do is I can host json files with data I want to put in and treat it as a API(since most API just return a json with proper content), like I have <code>latest.json</code> to show the latest 10 posts of my blog, you can view it through <a href="http://taoalpha.me/blog/api/latest.json">this link</a>.</p>
<p>Yup. This is the basic idea, and how to do it? We need build a plugin for hexo :)</p>
<p>A plugin for hexo is a normal module for node, so you need to define the package.json and the index.js, its totally fine that you only have one js file if you don’t need to deal with complicated logic things. But this time, I use two js files, the <code>index.js</code> would load the config from the hexo and assing the task to different generators. :)</p>
<p>And this is modified from the source code of <a href="https://github.com/hexojs/hexo-generator-sitemap" target="_blank" rel="external">hexo-generator-sitemap</a> :)</p>
<p>Since they are using pretty much the same logic, I just remove the built-in modules: sitemap and feed generator, and combine them into one.</p>
<p>Here it is:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// this is the index.js</span></span><br><span class="line"><span class="keyword">var</span> merge = <span class="built_in">require</span>(<span class="string">'utils-merge'</span>);</span><br><span class="line"><span class="keyword">var</span> pathFn = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// load the config from the hexo.config and combine them with some default configurations</span></span><br><span class="line"><span class="keyword">var</span> config = hexo.config.api = merge(&#123;</span><br><span class="line">  sitemap:&#123;</span><br><span class="line">    src: <span class="string">"sitemap.jade"</span>,</span><br><span class="line">    desc: <span class="string">"sitemap"</span>,</span><br><span class="line">    path: <span class="string">"sitemap.xml"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  feed:&#123;</span><br><span class="line">    src: <span class="string">"feed.jade"</span>,</span><br><span class="line">    desc: <span class="string">"feed"</span>,</span><br><span class="line">    path: <span class="string">"feed.xml"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;, hexo.config.api);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> gen = <span class="built_in">require</span>(<span class="string">'./lib/generator'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// assign them to different generators</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">var</span> item <span class="keyword">in</span> config)&#123;</span><br><span class="line">  (<span class="function"><span class="keyword">function</span>(<span class="params">item</span>)</span>&#123;hexo.extend.generator.register(item, <span class="function"><span class="keyword">function</span>(<span class="params">locals</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> gen(item,hexo.config,locals)</span><br><span class="line">  &#125;)</span><br><span class="line">  &#125;)(item)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// this is the ./lib/generator.js</span></span><br><span class="line"><span class="keyword">var</span> jade = <span class="built_in">require</span>(<span class="string">'jade'</span>);</span><br><span class="line"><span class="keyword">var</span> pathFn = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// main functions, current only deal with the latest posts if it is a json file task :)</span></span><br><span class="line"><span class="comment">// if it is xml task, then it will render the default template ( sitemap.jade, feed.jade)</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">item,config,locals</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">var</span> api = config.api</span><br><span class="line">  <span class="keyword">if</span>(api[item].path.endsWith(<span class="string">"json"</span>))&#123;</span><br><span class="line">    <span class="keyword">var</span> posts = locals.posts.toArray()</span><br><span class="line">      .sort(<span class="function"><span class="keyword">function</span>(<span class="params">a, b</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> b.updated - a.updated;</span><br><span class="line">      &#125;);</span><br><span class="line">    <span class="keyword">var</span> data = [],count = <span class="number">0</span></span><br><span class="line">    posts.forEach( (post) =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span>(count &gt; (api[item].limit || <span class="number">10</span>))&#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">var</span> temp = &#123;&#125;</span><br><span class="line">      post.date = <span class="keyword">new</span> <span class="built_in">Date</span>(post.date).toLocaleDateString()</span><br><span class="line">      api[item].attr.forEach( (v)=&gt;&#123;</span><br><span class="line">        <span class="keyword">if</span>(v == <span class="string">"summary"</span>)&#123;</span><br><span class="line">          temp[v] = post.content.replace(<span class="regexp">/(&lt;([^&gt;]+)&gt;)/ig</span>,<span class="string">''</span>).slice(<span class="number">0</span>,<span class="number">200</span>)</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">          temp[v] = post[v]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      count ++</span><br><span class="line">      data.push(temp)</span><br><span class="line">    &#125;)</span><br><span class="line">    data = <span class="built_in">JSON</span>.stringify(data)</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">// for xml(now only support sitemap, feed since I only these two templates :)</span></span><br><span class="line">    <span class="keyword">var</span> templateSrc= pathFn.join(__dirname, <span class="string">'../'</span>+api[item].src);</span><br><span class="line">    <span class="keyword">var</span> tmpl = jade.compile(fs.readFileSync(templateSrc, <span class="string">'utf8'</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> posts = [].concat(locals.posts.toArray(), locals.pages.toArray())</span><br><span class="line">      .filter(<span class="function"><span class="keyword">function</span>(<span class="params">post</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> post.sitemap !== <span class="literal">false</span>;</span><br><span class="line">      &#125;)</span><br><span class="line">      .sort(<span class="function"><span class="keyword">function</span>(<span class="params">a, b</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> b.updated - a.updated;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> data= tmpl(&#123;</span><br><span class="line">      config: config,</span><br><span class="line">      posts: posts</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    path: api[item].path,</span><br><span class="line">    data: data</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>That’s it.</p>
<p>I love hexo!! I love JS!!! :)</p>
<aside class="tipme special"><a href="/blog/tipme" class="tipme">If you like my work, buy me a soda or send me a book ! ^_^</a></aside></section><aside class="sidenav"><input type="text" placeholder="Enter to search" class="st-default-search-input searchbox"></aside><div class="relatedposts sidenav"><h2>Related Posts:</h2><ul class="article-list"><li><a href="http://taoalpha.me/blog/2015/09/30/tech-use-javascript-to-send-email/">Use only JavaScript to send email</a></li><li><a href="http://taoalpha.me/blog/2015/05/12/tech-js-date-to-chinese/">JS实现中文日期的方法</a></li><li><a href="http://taoalpha.me/blog/2015/05/07/tech-jekyll-tips-2/">Jekyll 筛选 tag 的实现</a></li><li><a href="http://taoalpha.me/blog/2015/05/06/tech-startss-invitation-code/">Start SS邀请码抢码活动</a></li></ul></div><aside class="sidenav"><div class="recentposts"><h2>Recent Posts:</h2><ul class="article-list"><li><a href="http://taoalpha.me/blog/2016/01/11/tech-es6-quiz-with-answer/">ES6 Quiz With Answer</a></li><li><a href="http://taoalpha.me/blog/2016/01/09/read-javascript-coding-style/">JavaScript Coding Style</a></li><li><a href="http://taoalpha.me/blog/2016/01/06/oj-oj-leetcode-sort-3/">OJ LeetCode Sort 3</a></li><li><a href="http://taoalpha.me/blog/2016/01/05/oj-oj-leetcode-sort-2/">OJ LeetCode Sort 2</a></li><li><a href="http://taoalpha.me/blog/2016/01/04/oj-oj-leetcode-sort-1/">OJ LeetCode Sort 1</a></li></ul></div></aside><div class="comments"><div data-thread-key="2015/12/27/tech-related-articles-and-generate-api-files-in-hexo/" data-title="Related Articles and generate API files in Hexo" data-url="http://taoalpha.me/blog/2015/12/27/tech-related-articles-and-generate-api-files-in-hexo/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"taoalpha"};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0] 
   || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script></div></article><div class="notification fail hidden"></div><!-- jquery--><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-46725017-2",'auto');ga('send','pageview');</script><script>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
_st('install','CUMLELEvkSRAFuVehSCm','2.0.0');</script><!-- main functions--><script src="/blog/js/functions.js"></script><script src="/blog/js/default.js"></script><script src="/blog/js/post.js"></script></body></html>