<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 优化 Jekyll 的相关文章列表 | TaoAlpha's Blog</title><meta name="description" content="Here is my new blog based on hexo."><meta name="viewport" content="width=device-width, initial-scale=1"><!-- open graph part--><meta property="og:image" content="http://taoalpha.me/images/newblog.jpg"><meta property="og:description" content="TaoAlpha's hexo Blog"><meta property="og:type" content="website"><link rel="short icon" href="/blog/favicon.png"><link rel="stylesheet" href="/blog/css/default.css"></head><body class="blogpost"><aside class="home-menu"><nav class="home-icon-con upside"></nav><a href="/blog/" class="home-menu-icon brand active">涛</a><a href="/blog/mylinks" class="home-menu-icon"><i class="fa fa-1x fa-anchor"></i></a><a href="/blog/tipme" class="home-menu-icon"><i class="fa fa-1x fa-gratipay"></i></a><a href="javascript:$('.searchbox').focus().css('border', '4px dashed #666');setTimeout(function(){$('.searchbox').focus().css('border', 'none').css('border-bottom', '1px solid #ccc')},1000);" class="home-menu-icon"><i class="fa fa-1x fa-search"></i></a><a href="/blog/puzzle" class="home-menu-icon"><i class="fa fa-1x fa-puzzle-piece"></i></a><a href="javascript:;" title="Contact Me" class="home-menu-icon follow">+</a><div class="home-contact"><a href="http://facebook.com/zzgary/" target="something"><img src="https://cdn1.iconfinder.com/data/icons/social-shade-rounded-rects/512/facebook-32.png" alt="facebook"></a><a href="http://github.com/taoalpha/" target="something"><img src="https://cdn1.iconfinder.com/data/icons/social-shade-rounded-rects/512/github-32.png" alt="github"></a><a href="http://taoalpha.me" target="something"><img src="https://cdn3.iconfinder.com/data/icons/colore-sociale/32/mewally_32x32.png" alt="portfolio"></a><a href="http://douban.com/people/129154019" target="something"><img src="http://img3.douban.com/favicon.ico" alt="douban"></a></div><nav class="home-icon-con downside"><a href="#contribution" class="home-menu-icon makecontribution"><i class="fa fa-pencil fa-1x"></i></a><a id="togglemusic" href="javascript:;" class="home-menu-icon"><i class="fa fa-music fa-1x"></i></a></nav><div id="musicbar"><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="298" height="40" src=""></iframe></div></aside><div id="contribution" class="hide"><span class="close"></span><input id="sender_mail" type="email" placeholder="Give me your email"><textarea id="contributionContent" name="contribution" cols="30" rows="10" placeholder="Thanks for your contribution!  Now tell me what you want to say: feedback ? advice ? contributions ? Whatever you want ^_^.  I will look at it as soon as I receive it and reply you asap.  "></textarea><input id="sendToMe" type="submit"></div><article id="content"><section class="entry"><h1 class="entry-title"><a href="http://taoalpha.me/blog/2015/06/06/tech-jekyll-related-posts-optimization/" title="优化 Jekyll 的相关文章列表">优化 Jekyll 的相关文章列表</a></h1><div class="meta-top"><a href="/blog/user/TaoAlpha"><div style="display:inline-block;" class="avatar"><img src="https://avatars3.githubusercontent.com/u/4335753?v=3&amp;s=40" alt="100"></div><span>TaoAlpha</span></a><span>2015-06-06</span><span class="wordage">7092字</span><span class="readspeed">21 分钟读完</span></div><h2 id="u7F18_u8D77"><a href="#u7F18_u8D77" class="headerlink" title="缘起"></a>缘起</h2><p>相关文章这个模块一直算是博客的一个标配组件之一, jekyll默认也是有着<code>site.related_posts</code>这个函数的, 可以调用jekyll帮助你生成的相关博文列表. 不过其准确性和相关性都很让人不放心… 从其<a href="https://github.com/jekyll/jekyll/blob/master/lib/jekyll/related_posts.rb" target="_blank" rel="external">源码</a>来看, 在默认关闭<code>lsi</code>的情况下, related_post产出的其实就是简单的最近文章列表… </p>
<p>这样当然不可以! 于是, 本文就是我在针对<code>related_post</code>这部分做了一些优化后的产物~ 请君品鉴 ^_^</p>
<h2 id="u65E0_u63D2_u4EF6_u65B9_u6CD5"><a href="#u65E0_u63D2_u4EF6_u65B9_u6CD5" class="headerlink" title="无插件方法"></a>无插件方法</h2><p>首先当然是希望能在不使用插件的情况下实现, 于是就看到了<a href="http://zhangwenli.com/blog/2014/07/15/jekyll-related-posts-without-plugin/" target="_blank" rel="external">Jekyll Related Posts without Plugin - 羡辙杂俎</a> 这个大神级妹子的博文~ 很有启发性嘛 基本上我要做的她都做过啦…哈哈</p>
<p>不过我稍微简化了以下代码以及结构, 所以可能会更易懂一些喽~哈</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;&#10;&#10;&#123;% comment %&#125; &#21033;&#29992;split &#26469;&#24418;&#25104;&#19968;&#20010;&#31354;&#25968;&#32452;, &#36825;&#37324;&#20027;&#35201;&#26159;&#25105;&#19981;&#30693;&#36947;liquid&#22914;&#20309;&#30452;&#25509;&#20889;array... &#123;% endcomment %&#125; &#10;&#123;% assign postsAfterFilter = &#39;-&#39; | split: &#34;-&#34; %&#125;&#10;&#123;% for post in site.related_posts %&#125;&#10;  &#123;% assign commonTagCount = 0 %&#125;&#10;  &#123;% if post.title != page.title and post.series != page.series %&#125;&#10;    &#123;% for tag in post.tags %&#125; &#10;      &#123;% if page.tags contains tag %&#125;&#10;&#10;        &#123;% comment %&#125; &#32479;&#35745;&#20849;&#21516;&#30340;tag&#30340;&#25968;&#30446;, &#29992;&#26469;&#21518;&#38754;&#30340;&#31579;&#36873;&#20197;&#21450;&#25490;&#24207;&#29992; &#123;% endcomment %&#125; &#10;        &#123;% assign commonTagCount = commonTagCount | plus: 1 %&#125;&#10;      &#123;% endif %&#125;&#10;    &#123;% endfor %&#125;&#10;    &#123;% if commonTagCount &#62; 0 %&#125;&#10;&#10;      &#123;% comment %&#125; &#23558;&#31526;&#21512;&#26465;&#20214;&#30340;post&#25918;&#20837;&#19968;&#20010;&#26032;&#30340;&#25968;&#32452;&#20043;&#20013; &#123;% endcomment %&#125; &#10;      &#123;% assign postsAfterFilter = postsAfterFilter | push: post %&#125;&#10;    &#123;% endif %&#125;&#10;  &#123;% endif %&#125;&#10;&#123;% endfor %&#125;&#10;&#10;&#123;% comment %&#125; &#23481;&#38169;&#21028;&#26029;, &#30830;&#20445;&#26377;&#30456;&#20851;&#25991;&#31456;&#30340;&#26102;&#20505;&#20877;&#23637;&#31034;&#30456;&#20851;&#25991;&#31456; &#123;% endcomment %&#125; &#10;&#123;% if postsAfterFilter.size &#62; 0 %&#125;&#10;&#60;div class=&#34;relatedposts&#34;&#62;&#10;  &#60;h2&#62;Related Posts:&#60;/h2&#62;&#10;  &#60;ul class=&#34;article-list&#34;&#62;&#10;  &#123;% for post in postsAfterFilter limit: 5 %&#125;&#10;    &#60;li&#62;&#60;a href=&#34;&#123;&#123; site.baseurl &#125;&#125;&#123;&#123; post.url &#125;&#125;&#34;&#62;&#123;&#123; post.title &#125;&#125;&#60;/a&#62;&#60;/li&#62;&#10;  &#123;% endfor %&#125;&#10;  &#60;/ul&#62;&#10;&#60;/div&#62;&#10;&#123;% endif %&#125;&#10;&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>思路很简单, 确保其具有共同tag, 在无相关文章的情况下就不展示此模块了. 因为本身liquid的语法非常有限, 不借助插件的情况下, 想要实现更多功能的话, 就比较麻烦了. 如果有哪位XDJM有不借助插件的排序, 求务必告知我哦~</p>
<blockquote class="special update" markdown="1" data-flag="gotsomeupdateshere"><br><br>### Update<br><br>哈哈, 和朋友@小田讨论了下, 终于想到一个不用插件实现排序的方法了~ 代码如下:<br><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;&#10;&#123;% comment %&#125; &#19968;&#33268;&#21040;&#33719;&#21462;postsAfterFilter&#20197;&#21450;tagCountEachPost&#30340;&#37096;&#20998;&#37117;&#27809;&#26377;&#21464;&#21270;&#123;% endcomment %&#125;&#10;&#123;% comment %&#125; &#19979;&#38754;&#21017;&#20351;&#29992;&#20102;&#19968;&#20010;&#21472;&#21152;for&#24490;&#29615;&#26469;&#36880;&#27425;&#23547;&#25214;&#26368;&#22823;&#30340;tagcount, &#28982;&#21518;&#21516;&#27493;&#36755;&#20986;&#23545;&#24212;postsAfterFilter&#30340;&#20540;&#123;% endcomment %&#125;&#10;&#123;% if postsAfterFilter.size &#62; 0 %&#125;&#10;&#60;div class=&#34;relatedposts&#34;&#62;&#10;  &#60;h2&#62;Related Posts:&#60;/h2&#62;&#10;  &#60;ul class=&#34;article-list&#34;&#62;&#10;&#123;% assign j = tagCountEachPost | size | minus: 1 %&#125;&#10;&#123;% assign maxIndex = 0 %&#125;&#10;&#123;% assign getFirstNumber = true %&#125;&#10;&#123;% assign selectedIndex = &#34;-&#34;|split: &#34;-&#34; %&#125;&#10;&#123;% for p in (0..j) %&#125;&#10;  &#123;% for i in (0..j) %&#125;&#10;    &#123;% unless selectedIndex contains i %&#125;&#10;      &#123;% if getFirstNumber %&#125;&#10;        &#123;% assign firstNumber = tagCountEachPost[i] %&#125;&#10;        &#123;% assign getFirstNumber = false %&#125;&#10;      &#123;% endif %&#125;&#10;      &#123;% if tagCountEachPost[i] &#62;= firstNumber %&#125;&#10;        &#123;% assign firstNumber = tagCountEachPost[i] %&#125;&#10;        &#123;% assign maxIndex = i %&#125;&#10;      &#123;% endif %&#125;&#10;    &#123;% endunless %&#125;&#10;  &#123;% endfor %&#125;&#10;  &#123;% assign getFirstNumber = true %&#125;&#10;  &#123;% assign selectedIndex = selectedIndex | push: maxIndex %&#125;&#10;  &#123;% if selectedIndex.size &#60; 6 %&#125;&#10;    &#60;li&#62;&#60;a href=&#34;&#123;&#123; site.baseurl &#125;&#125;&#123;&#123; postsAfterFilter[maxIndex][&#39;url&#39;] &#125;&#125;&#34;&#62;&#123;&#123; postsAfterFilter[maxIndex][&#39;title&#39;] &#125;&#125;&#60;/a&#62;&#60;/li&#62;&#10;  &#123;% endif %&#125;&#10;&#123;% endfor %&#125;&#10;&#60;/ul&#62;&#10;&#60;/div&#62;&#10;&#123;% endif %&#125;&#10;&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure><br><br>思路也很简单, 就是利用for循环写出一个找最大元素的方法, 然后每次记录下最大元素的index, 就能同步输出对应的post了~ 需要注意的就是<strong>为了保证index的一一对应, 需要单独保存每次找到的最大值的index, 然后在下一次遍历中跳过</strong><br><br>赞!<br></blockquote>

<h2 id="u6709_u63D2_u4EF6_u4E0B_u589E_u52A0_u6392_u5E8F_u529F_u80FD"><a href="#u6709_u63D2_u4EF6_u4E0B_u589E_u52A0_u6392_u5E8F_u529F_u80FD" class="headerlink" title="有插件下增加排序功能"></a>有插件下增加排序功能</h2><h3 id="liquid__u90E8_u5206"><a href="#liquid__u90E8_u5206" class="headerlink" title="liquid 部分"></a>liquid 部分</h3><p>在上面的基础上(在update之前的基础上), 首先我们需要在liquid中添加几行代码:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw %&#125;&#10;&#123;% comment %&#125; &#39318;&#20808;&#38656;&#35201;&#23450;&#20041;&#19968;&#20010;&#26032;&#30340;&#21464;&#37327;, &#29992;&#26469;&#35760;&#24405;&#20849;&#21516;&#30340;tag&#25968;&#30446; &#123;% endcomment %&#125; &#10;&#123;% assign tagCountEachPost = &#39;-&#39; | split: &#34;-&#34; %&#125;&#10;&#10;&#123;% comment %&#125; &#22312;&#36825;&#19968;&#27493;&#31867;&#20284;&#28155;&#21152;&#30340;post&#30340;&#26041;&#24335;, &#25226;&#23545;&#24212;&#30340;&#20849;&#21516;tag&#25968;&#30446;&#20063;&#32452;&#25104;&#19968;&#20010;&#32467;&#26500;&#19968;&#26679;&#30340;&#23545;&#24212;&#25968;&#32452;&#123;% endcomment %&#125; &#10;&#123;% if commonTagCount &#62; 0 %&#125;&#10;  &#123;% assign postsAfterFilter = postsAfterFilter | push: post %&#125;&#10;  &#123;% assign tagCountEachPost = tagCountEachPost | push: commonTagCount %&#125;&#10;&#123;% endif %&#125;&#10;&#10;&#123;% comment %&#125; &#36825;&#37324;&#23545;&#25991;&#31456;&#36827;&#34892;&#23545;&#24212;&#30340;&#31579;&#36873;, &#38656;&#35201;&#20511;&#21161;&#25105;&#20204;&#33258;&#23450;&#20041;&#30340;filter&#23454;&#29616; &#123;% endcomment %&#125; &#10;&#123;% assign postsAfterFilter = postsAfterFilter | sort_by_array: &#123;&#123;tagCountEachPost&#125;&#125; %&#125;&#10;      &#10;&#123;% endraw %&#125;</span><br></pre></td></tr></table></figure>
<p>下面就是插件环节~</p>
<h3 id="u63D2_u4EF6_u90E8_u5206"><a href="#u63D2_u4EF6_u90E8_u5206" class="headerlink" title="插件部分"></a>插件部分</h3><p>Jekyll 的插件都是<code>.rb</code>结尾的文件, 放在<code>_plugins</code>路径下即可. 这里<code>filters.rb</code>是我用来专门放置我自己定制的filter的:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># filters.rb</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Jekyll</span></span></span><br><span class="line">  <span class="class"><span class="keyword">module</span> <span class="title">CustomizeFilter</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sort_by_array</span><span class="params">(fArray,sArray)</span></span></span><br><span class="line">      newObj = &#123;&#125;</span><br><span class="line">      newArray = []</span><br><span class="line">      sArray.each_index <span class="keyword">do</span> |x|</span><br><span class="line">        newObj[x] = sArray[x]</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      newObj.sort_by&#123;|_key, value| value &#125;.each <span class="keyword">do</span> |x,y|</span><br><span class="line">        newArray.push(fArray[x])</span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">      newArray.reverse!</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="constant">Liquid::Template</span>.register_filter(<span class="constant">Jekyll::CustomizeFilter</span>)</span><br></pre></td></tr></table></figure>
<p>如此基本就算搞定啦~</p>
<h2 id="u53C2_u8003_u8D44_u6599"><a href="#u53C2_u8003_u8D44_u6599" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="http://zhangwenli.com/blog/2014/07/15/jekyll-related-posts-without-plugin/" target="_blank" rel="external">Jekyll Related Posts without Plugin - 羡辙杂俎 </a></li>
<li><a href="http://melandri.net/Custom-Jekyll-filter-for-tags/" target="_blank" rel="external">Custom Jekyll filter for tags</a></li>
<li><a href="http://stackoverflow.com/questions/2540435/how-to-sort-a-ruby-hash-by-number-value" target="_blank" rel="external">How to sort a Ruby Hash by number value?</a></li>
</ul>
<aside class="tipme special"><a href="/blog/tipme" class="tipme">If you like my work, buy me a soda or send me a book ! ^_^</a></aside></section><aside class="sidenav"><input type="text" placeholder="Enter to search" class="st-default-search-input searchbox"></aside><aside class="sidenav series"><h2>In Serie: Jekyll Boost<i class="fa fa-arrow-down expand"></i><i class="collapse fa fa-arrow-up"></i></h2><ul class="article-list"><li><a href="http://taoalpha.me/blog/2015/06/01/tech-jekyll-tag-page/" data-id='null'>Jekyll 添加 tag 专属页面</a></li><li><a href="http://taoalpha.me/blog/2015/06/06/tech-jekyll-related-posts-optimization/" data-id='null' class="current">优化 Jekyll 的相关文章列表</a></li><li><a href="http://taoalpha.me/blog/2015/06/02/tech-jekyll-paginator-for-all-page/" data-id='null'>Jekyll 添加翻页部分(包含分类页,标签页)</a></li><li><a href="http://taoalpha.me/blog/2015/05/21/tech-jekyll-count-of-chinese-characters/" data-id='null'>Jekyll 中如何做中文字数统计</a></li><li><a href="http://taoalpha.me/blog/2015/06/21/tech-add-internal-search-to-jekyll-blog/" data-id='null'>自建倒排, 为 Jekyll 博客添加搜索功能</a></li></ul></aside><aside class="sidenav"><div class="recentposts"><h2>Recent Posts:</h2><ul class="article-list"></ul><li><a href="http://taoalpha.me/blog/2015/12/26/Summary-of-the-year/">Summary of the year</a></li><li><a href="http://taoalpha.me/blog/2015/12/26/blog-migration/">Blog Migration from jekyll to hexo</a></li><li><a href="http://taoalpha.me/blog/2015/12/07/tech-my-first-cli-tool-with-nodejs/">First CLI tool with NodeJS</a></li><li><a href="http://taoalpha.me/blog/2015/11/27/thanksgiving/">感恩</a></li><li><a href="http://taoalpha.me/blog/2015/11/19/tech-preventDefault-and-stopPropagation-in-JS/">preventDefault and stopPropagation in JS</a></li><li><a href="http://taoalpha.me/blog/2015/11/11/tech-use-strict-in-js/">Strict Mode in JavaScript</a></li></div></aside><div class="comments"><div data-thread-key="2015/06/06/tech-jekyll-related-posts-optimization/" data-title="优化 Jekyll 的相关文章列表" data-url="http://taoalpha.me/blog/2015/06/06/tech-jekyll-related-posts-optimization/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"taoalpha"};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0] 
   || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script></div></article><div class="notification fail hidden"></div><!-- jquery--><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-46725017-2",'auto');ga('send','pageview');</script><script>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
_st('install','CUMLELEvkSRAFuVehSCm','2.0.0');</script><!-- main functions--><script src="/blog/js/functions.js"></script><script src="/blog/js/default.js"></script><script src="/blog/js/post.js"></script></body></html>