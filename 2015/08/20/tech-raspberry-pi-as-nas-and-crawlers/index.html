<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 用 Raspberry Pi 做 NAS 和 采集器 | TaoAlpha's Blog</title><meta name="description" content="Here is my new blog based on hexo."><meta name="viewport" content="width=device-width, initial-scale=1"><!-- open graph part--><meta property="og:image" content="http://taoalpha.me/images/newblog.jpg"><meta property="og:description" content="TaoAlpha's hexo Blog"><meta property="og:type" content="website"><link rel="short icon" href="/blog/favicon.png"><link rel="stylesheet" href="/blog/css/default.css"></head><body class="blogpost"><aside class="home-menu"><nav class="home-icon-con upside"></nav><a href="/blog/" class="home-menu-icon brand active">涛</a><a href="/blog/tipme" class="home-menu-icon"><i class="fa fa-1x fa-gratipay"></i></a><a href="javascript:$('.searchbox').focus().css('border', '4px dashed #666');setTimeout(function(){$('.searchbox').focus().css('border', 'none').css('border-bottom', '1px solid #ccc')},1000);" class="home-menu-icon"><i class="fa fa-1x fa-search"></i></a><a href="/blog/puzzle" class="home-menu-icon"><i class="fa fa-1x fa-puzzle-piece"></i></a><a href="javascript:;" title="Contact Me" class="home-menu-icon follow">+</a><div class="home-contact"><a href="http://facebook.com/zzgary/" target="something"><img src="https://cdn1.iconfinder.com/data/icons/social-shade-rounded-rects/512/facebook-32.png" alt="facebook"></a><a href="http://github.com/taoalpha/" target="something"><img src="https://cdn1.iconfinder.com/data/icons/social-shade-rounded-rects/512/github-32.png" alt="github"></a><a href="http://taoalpha.me" target="something"><img src="https://cdn3.iconfinder.com/data/icons/colore-sociale/32/mewally_32x32.png" alt="portfolio"></a><a href="http://douban.com/people/129154019" target="something"><img src="http://img3.douban.com/favicon.ico" alt="douban"></a></div><nav class="home-icon-con downside"><a href="#contribution" class="home-menu-icon makecontribution"><i class="fa fa-pencil fa-1x"></i></a><a id="togglemusic" href="javascript:;" class="home-menu-icon"><i class="fa fa-music fa-1x"></i></a></nav><div id="musicbar"><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="298" height="40" src=""></iframe></div></aside><div id="contribution" class="hide"><span class="close"></span><input id="sender_mail" type="email" placeholder="Give me your email"><textarea id="contributionContent" name="contribution" cols="30" rows="10" placeholder="Thanks for your contribution!  Now tell me what you want to say: feedback ? advice ? contributions ? Whatever you want ^_^.  I will look at it as soon as I receive it and reply you asap.  "></textarea><input id="sendToMe" type="submit"></div><article id="content"><section class="entry"><h1 class="entry-title"><a href="http://taoalpha.me/blog/2015/08/20/tech-raspberry-pi-as-nas-and-crawlers/" title="用 Raspberry Pi 做 NAS 和 采集器">用 Raspberry Pi 做 NAS 和 采集器</a></h1><div class="meta-top"><a href="http://taoalpha.me"><div style="display:inline-block;" class="avatar"><img src="https://avatars3.githubusercontent.com/u/4335753?v=3&amp;s=40" alt="100"></div><span>TaoAlpha</span></a><span>2015-08-20</span><span class="wordage">7192字</span><span class="readspeed">21 分钟读完</span></div><h2 id="u5F15_u5B50"><a href="#u5F15_u5B50" class="headerlink" title="引子"></a>引子</h2><p>在之前<br><a href="/blog/2015/07/05/tech-raspberry-pi-setup/">Raspberry Pi Setup</a>一文中介绍了树莓派的初始配置. 这几天乘着还没开学, 就赶紧把树莓派重新跑起来, 虽然悲催的因为网络设定导致我的树莓派无法联网只能强制重刷了… 好在之前在家里就一直用 samba 把重要的脚本都存在了外置盘上, 而已抓取的数据也有早起的备份, 丢失的数据就没办法了..</p>
<p>所以正好相当于重新设定了一遍 NAS 和 diango , 本文做简单介绍, 方便后续查看.</p>
<h2 id="NAS"><a href="#NAS" class="headerlink" title="NAS"></a>NAS</h2><p>NAS 全称是: Network-attached Storage. 简单说就是在一个网络组中用来存储数据的地方, 而在这个网路组的所有用户都可以在相应的权限下查看, 编辑.</p>
<p>通常一个低配的 NAS 也要差不多100多刀左右, 当然其读写速度, 性能都是很棒的, 买来即用~ 不过作为穷屌丝一枚, 手头又有几个闲置的移动硬盘和 U 盘. 于是就参考网上的教程用树莓派做个简易的 NAS , 供个人和室友使用还是绰绰有余了~</p>
<h3 id="Samba"><a href="#Samba" class="headerlink" title="Samba"></a>Samba</h3><p>想要实现自用的 NAS, 主要依赖的就是 Samba 这个服务了. Samba 是基于 SMB 协议的一个服务. 利用它多平台的特性可以方便的在多平台上进行数据交换. 而自建 NAS 的核心即是: 以树莓派为搭载平台, 将链接其上的闲置硬盘作为共用存储器.</p>
<p>Samba 的安装和配置都很简单:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install samba samba-common-bin&#10;# &#20462;&#25913; /etc/samba/smb.conf &#24320;&#21551;&#23433;&#20840;&#26435;&#38480;, &#21462;&#28040; `security = user`&#30340;&#27880;&#37322;&#21363;&#21487;&#10;# &#36825;&#37324;&#20027;&#35201;&#26159;&#30830;&#20445;samba &#30340;&#29992;&#25143;&#24517;&#39035;&#26159;&#31995;&#32479;&#30340;&#29992;&#25143;&#20043;&#19968;&#10;&#10;# &#28982;&#21518;&#28155;&#21152;&#19979;&#38754;&#20869;&#23481;&#21040; /etc/samba/smb.conf &#20013;&#10;#[public]&#10;#&#27492;&#22788;&#25226;&#20844;&#20849;&#30424;&#30340;&#21517;&#23383;&#35774;&#23450;&#20026;&#20102; public, &#21487;&#20197;&#20462;&#25913;&#10;#  comment = Public Storage&#10;#  &#22791;&#27880;&#21517;&#10;#  path = /nas&#10;#  path &#36873;&#25321;&#33258;&#24049;&#25346;&#36733;&#30828;&#30424;&#30340;&#20301;&#32622;, &#21021;&#22987;&#24212;&#35813;&#26159;/dev/sdan &#36825;&#31181;&#26684;&#24335;&#30340;, &#21487;&#20197;&#36890;&#36807; `mount /dev/sdan /newpath`&#26469;&#20462;&#25913;;&#10;#  valid users = pi nas&#10;#  &#20998;&#37197;&#29992;&#25143;&#26435;&#38480;, &#36825;&#37324;&#32473;&#20104;&#20102; pi &#21644; nas &#20004;&#20010;&#29992;&#25143;&#30340;&#35775;&#38382;&#26435;&#38480;&#10;#  read only = no&#10;#  create mask = 0777&#10;#  public = yes&#10;#  writable = yes&#10;#  directory mask = 0777&#10;#  guest ok = yes&#10;#  browseable = yes</span><br></pre></td></tr></table></figure>
<p>其中, 如果希望每次开机自动挂载硬盘到自定义位置, 可以通过修改<code>/etc/fstab</code>文件来实现:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#22312;&#21407;&#26377;&#22522;&#30784;&#19978;&#28155;&#21152;(&#20462;&#25913; `/sda1` &#20026;&#20320;&#30340;&#30828;&#30424;&#21021;&#22987;&#25346;&#36733;&#20301;&#32622;):&#10;/dev/sda1       /nas            ext4    defaults          0       0</span><br></pre></td></tr></table></figure></p>
<p>在完成设定后, 就需要重启 samba 服务并添加对应用户了. 因为我们开启了<code>security = user</code>, 所以这里需要给 samba 添加系统用户, 比如默认的 pi 用户, 或者 root. 当然你可以通过<code>useradd</code>来给系统创建新用户.</p>
<p>创建用户后, 就可以给 samba 添加用户了.</p>
<p><code>smbpasswd -a username</code> 即可添加用户, <code>smbpasswd -e nas</code> 则启用此用户.</p>
<p>设定好对应用户的 samba 密码后即可通过你的电脑访问你的共享盘了, 你可以通过 connect 到 <code>smb://192.168.x.x</code>(你的 pi 地址), 然后输入对应的用户名密码即可~</p>
<p>PS. 如果你是用的 NTFS 的硬盘, 那么还需要安装<code>ntfs-3g</code>来实现对硬盘的读写功能, 如果你用的是 mac 的盘, 那么还需要安装<code>hfsplus</code>和<code>hfsutils</code>来实现同样的目的~ 上述都可以通过<code>apt-get</code>直接安装.</p>
<p>到此, 你的简易 nas 就算是完成了~ 可以享受喽~</p>
<h2 id="u91C7_u96C6_u5668"><a href="#u91C7_u96C6_u5668" class="headerlink" title="采集器"></a>采集器</h2><p>玩 python, 怎么能不写爬虫呢? 哈哈 因为树莓派低功耗, 全天候运行的特性, 作为爬虫可谓是绝佳的好平台 ^_^</p>
<h3 id="u652F_u6301_u5E93_u5B89_u88C5"><a href="#u652F_u6301_u5E93_u5B89_u88C5" class="headerlink" title="支持库安装"></a>支持库安装</h3><p>首先为了跟随时代潮流, 我选择3.4作为 python 主版本~ 2.7.6作为辅助. 这里可以通过<a href="https://github.com/utahta/pythonbrew" target="_blank" rel="external">Pythonbrew</a>来实现轻松管理 python 版本的目的. (注: pythonbrew 安装3.4的时候要使用3.4.0这种具体到小版本号的名称安装, 不然会找不到 package 的)</p>
<p>3.4已经自带了pip, 所以就可以不用自己安装了~ 接下来利用 pip 来安装支持库.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django&#10;# &#25105;&#27604;&#36739;&#20064;&#24815;django &#30340;&#26694;&#26550;&#20102;, &#22914;&#26524;&#20320;&#21916;&#27426; flask &#20063;&#21487;&#20197;&#26681;&#25454;&#33258;&#24049;&#30340;&#21916;&#22909;&#35843;&#25972;&#10;pip install beautifulsoup4&#10;# html &#35299;&#26512;&#24211;, &#24403;&#28982;, &#20320;&#20063;&#21487;&#20197;&#21033;&#29992; xpath &#26469;&#30828;&#35299;~&#10;pip install mysqlclient&#10;# &#36825;&#20010;&#26159; MySQLdb&#30340;&#19968;&#20010; fork, &#20294;&#26159;&#25552;&#20379;&#20102; python3&#30340;&#25903;&#25345;, &#29992;&#26469;&#20462;&#22797;&#25903;&#25345; p3 &#19979; django &#20351;&#29992; mysql .&#10;# &#22914;&#26524;&#19978;&#36848;&#25253;mysql &#30340;&#38169;&#35823;&#25110;&#32773;mysql_config not found, &#35831;&#30830;&#20445;&#20320;&#24050;&#32463;&#23433;&#35013;&#20102; mysql &#20197;&#21450; libmysqlclient-dev&#10;pip install pymysql&#10;# &#20064;&#24815;&#29992;&#36825;&#20010;&#20570;&#25235;&#21435;&#25554;&#20837;&#20102;... &#21487;&#20197;&#29992; MySQLdb &#30340;~&#10;pip install git+ssh://git@github.com/Supervisor/supervisor.git&#10;# &#22240;&#20026; supervisor &#22312; pip &#30340;&#29256;&#26412;&#19981;&#25903;&#25345; p3, &#25152;&#20197;&#38656;&#35201;&#33258;&#24049;&#30452;&#25509;&#21033;&#29992; pip &#23433;&#35013; git &#19978;&#30340;&#29256;&#26412;.&#10;# &#38656;&#35201;&#20808;&#28155;&#21152; sshkey &#21040; github &#19978;, &#19981;&#28982;&#26080;&#27861; clone &#30340;~ &#30456;&#20851;&#35831;&#26597;&#30475; github &#23448;&#26041;&#20171;&#32461;.</span><br></pre></td></tr></table></figure>
<p>到此, 基本库就算是差不多全了.</p>
<h3 id="django"><a href="#django" class="headerlink" title="django"></a>django</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django-admin startproject PROJECT_NAME&#10;# &#21019;&#24314;&#26032;&#39033;&#30446;&#10;django-admin startapp APP_NAME&#10;# &#21019;&#24314;&#26032; app</span><br></pre></td></tr></table></figure>
<p>修改 project 里的 <code>settings.py</code>, 替换 database 的配置(根据你是用的 db 库修改), 添加 APP_NAME 到 INSTALLED_APPS 里.</p>
<h3 id="u91C7_u96C6APP"><a href="#u91C7_u96C6APP" class="headerlink" title="采集APP"></a>采集APP</h3><p>根据自己的情况修改 APP 的 <code>models.py</code> 创建表结构.</p>
<p>同步数据库:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py migrate&#10;# &#21516;&#27493; django &#30340;&#25968;&#25454;&#24211;&#10;python manage.py makemigrations APP_NAME&#10;# APP &#34920;&#32467;&#26500;&#36801;&#31227;&#10;python manage.py sqlmigrate crawlers 000x&#10;# APP SQL &#36801;&#31227;(&#21487;&#20197;&#39044;&#35272;&#19979; SQL). &#36825;&#37324;&#30340;000x &#26159;&#26681;&#25454;&#19978;&#19968;&#27493; makemigrations &#24471;&#21040;&#30340; version &#32534;&#30721;, &#19968;&#33268;&#21363;&#21487;&#10;python manage.py migrate&#10;# &#21516;&#27493;&#25968;&#25454;&#24211;, &#27491;&#24335;&#29983;&#25928;</span><br></pre></td></tr></table></figure>
<p>此外, 记得创建一个 admin user 并且把 admin 的静态文件转移过来~ (需要在 project 的 settings.py 中设定<code>STATIC_ROOT</code>路径)</p>
<p><code>python manage.py createsuperuser</code></p>
<p><code>python manage.py collectstatic</code></p>
<p>通过这个就可以登录 django 的 admin 后台了~</p>
<h3 id="u91C7_u96C6_u811A_u672C"><a href="#u91C7_u96C6_u811A_u672C" class="headerlink" title="采集脚本"></a>采集脚本</h3><p>接下来就是数据库的填充了~ 这里就得根据自己的情况来写爬虫喽~</p>
<h3 id="supervisor__u81EA_u542F_u52A8"><a href="#supervisor__u81EA_u542F_u52A8" class="headerlink" title="supervisor 自启动"></a>supervisor 自启动</h3><p>supervisor 是很好的系统任务管理工具. 利用它可以更方便的管理我们的 django 以及其他的项目, 如果有的话.</p>
<p>上面安装支持库中已经成功的为 python 3 安装了 supervisor, 所以这里我们就可以直接进入到配置环节了:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[supervisord]&#10;[program:pragram_name]&#10;directory=path_to_django_project&#10;command=python manage.py runserver&#10;autorestart=true&#10;autostart=true</span><br></pre></td></tr></table></figure>
<p>DONE! 保存这一配置文件到你的任意目录中, 只要记得启动<code>supervisord</code>的时候利用<code>-c</code>指定到这一配置文件即可.</p>
<h3 id="nginx__u6620_u5C04"><a href="#nginx__u6620_u5C04" class="headerlink" title="nginx 映射"></a>nginx 映射</h3><p>为了让我们能够在局域网的其他机器上直接访问我们的 django, 我们需要把 nginx 映射到我们的 django 去~</p>
<p>最简单的方法就是, 利用<code>proxy_pass http://127.0.0.1:8000;</code>将80端口直接导向我们的 django server 所在.</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">server</span> &#123;</span><br><span class="line">    <span class="title">listen</span>   <span class="number">80</span>;</span><br><span class="line">    <span class="title">server_name</span> localhost;</span><br><span class="line">    <span class="title">access_log</span>  /var/log/nginx/access.log;</span><br><span class="line">    <span class="title">error_log</span> /var/log/nginx/error.log <span class="built_in">debug</span>;</span><br><span class="line">    <span class="title">rewrite_log</span> <span class="built_in">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="title">location</span> / &#123;</span><br><span class="line">        <span class="title">proxy_pass</span> <span class="url">http://127.0.0.1:8000</span>;</span><br><span class="line">        <span class="title">proxy_redirect</span>  <span class="built_in">off</span>;</span><br><span class="line">            <span class="title">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">            <span class="title">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="title">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title">location</span> /static/ &#123;</span><br><span class="line">        <span class="title">root</span> path_to_project;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 如此, 通过 <code>supervisord -c path_to_supervisor_conf</code> 就可以启动你的 django 了~ 稍等片刻, 你就可以通过访问你的树莓派 ip 看到成功搭建的 django 欢迎页面了~</p>
<p>PS. 如果不喜欢手动加载 supervisor 配置, 也可以把配置文件放到 supervisor 的系统配置目录中, 然后就可以通过<code>supervisord  start supervisor_program_name</code>来启动了~</p>
<p>恩, 就到这里了~ 下一步就是在我的树莓派上搭建一个每天任务跟踪的服务了~ 这个还需要好好想想~ ^_^</p>
<h2 id="u53C2_u8003"><a href="#u53C2_u8003" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://docs.djangoproject.com/en/1.8/intro/" target="_blank" rel="external">django Getting started</a></li>
<li><a href="https://github.com/PyMySQL/mysqlclient-python" target="_blank" rel="external">MySQL database connector for Python (with Python 3 support)</a></li>
<li><a href="http://stackoverflow.com/questions/4830856/is-it-possible-to-use-pip-to-install-a-package-from-a-private-github-repository" target="_blank" rel="external">pip install from git repo</a></li>
<li><a href="http://stackoverflow.com/questions/7475223/mysql-config-not-found-when-installing-mysqldb-python-interface" target="_blank" rel="external">mysql_config not found when installing mysqldb python interface</a></li>
</ul>
<aside class="tipme special"><a href="/blog/tipme" class="tipme">If you like my work, buy me a soda or send me a book ! ^_^</a></aside></section><aside class="sidenav"><input type="text" placeholder="Enter to search" class="st-default-search-input searchbox"></aside><aside class="sidenav series"><h2>In Serie: The Way I learn Pi<i class="fa fa-arrow-down expand"></i><i class="collapse fa fa-arrow-up"></i></h2><ul class="article-list"><li><a href="http://taoalpha.me/blog/2015/07/05/tech-raspberry-pi-setup/" data-id='null'>Raspberry Pi Setup</a></li><li><a href="http://taoalpha.me/blog/2015/08/20/tech-raspberry-pi-as-nas-and-crawlers/" data-id='null' class="current">用 Raspberry Pi 做 NAS 和 采集器</a></li></ul></aside><div class="relatedposts sidenav"><h2>Related Posts:</h2><ul class="article-list"><li><a href="http://taoalpha.me/blog/2015/07/05/tech-raspberry-pi-setup/">Raspberry Pi Setup</a></li><li><a href="http://taoalpha.me/blog/2015/10/14/tech-raspberry-pi-kernel-panic-data-restore/">Restore your database in Raspberry Pi from kernel panic error</a></li></ul></div><aside class="sidenav"><div class="recentposts"><h2>Recent Posts:</h2><ul class="article-list"><li><a href="http://taoalpha.me/blog/2015/12/26/Close-old-website-and-related-services/">Close old website and related services</a></li><li><a href="http://taoalpha.me/blog/2015/12/07/tech-my-first-cli-tool-with-nodejs/">First CLI tool with NodeJS</a></li><li><a href="http://taoalpha.me/blog/2015/11/27/thanksgiving/">感恩</a></li><li><a href="http://taoalpha.me/blog/2015/11/11/tech-use-strict-in-js/">Strict Mode in JavaScript</a></li><li><a href="http://taoalpha.me/blog/2015/11/06/tech-es6-general-summary/">ES6 General Summary</a></li></ul></div></aside><div class="comments"><div data-thread-key="2015/08/20/tech-raspberry-pi-as-nas-and-crawlers/" data-title="用 Raspberry Pi 做 NAS 和 采集器" data-url="http://taoalpha.me/blog/2015/08/20/tech-raspberry-pi-as-nas-and-crawlers/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"taoalpha"};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0] 
   || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script></div></article><div class="notification fail hidden"></div><!-- jquery--><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-46725017-2",'auto');ga('send','pageview');</script><script>(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
(w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
})(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
_st('install','CUMLELEvkSRAFuVehSCm','2.0.0');</script><!-- main functions--><script src="/blog/js/functions.js"></script><script src="/blog/js/default.js"></script><script src="/blog/js/post.js"></script></body></html>